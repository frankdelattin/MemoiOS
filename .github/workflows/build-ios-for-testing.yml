name: Build iOS for Testing

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ feature/vector-cleanup-implementation ]

jobs:
  build-ios:
    name: Build iOS App for BrowserStack Testing
    runs-on: macos-13  # Use specific macOS version for stability
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Clean and get dependencies
      run: |
        flutter clean
        flutter pub get
        
    - name: Generate ObjectBox files
      run: |
        dart run build_runner build --delete-conflicting-outputs
        
    - name: Build iOS app (debug, no codesign)
      run: |
        flutter build ios --debug --no-codesign --verbose
        
    - name: Verify build output
      run: |
        ls -la ios/build/ios/iphoneos/
        if [ ! -d "ios/build/ios/iphoneos/Runner.app" ]; then
          echo "‚ùå Runner.app not found!"
          exit 1
        fi
        echo "‚úÖ Runner.app found successfully"
        
    - name: Create iOS app archive
      run: |
        cd ios/build/ios/iphoneos
        zip -r SnappApp-iOS-Debug.zip Runner.app
        ls -la SnappApp-iOS-Debug.zip
        
    - name: Upload iOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-for-testing
        path: ios/build/ios/iphoneos/SnappApp-iOS-Debug.zip
        retention-days: 7
        
    - name: Build summary
      run: |
        echo "üéâ iOS app built successfully!"
        echo "üì± Download the artifact from GitHub Actions"
        echo "üì§ Upload SnappApp-iOS-Debug.zip to BrowserStack"
        echo "üß™ Ready for vector cleanup testing!"
