name: Build iOS for Testing

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ feature/vector-cleanup-implementation ]

jobs:
  build-ios:
    name: Build iOS App for BrowserStack Testing
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Generate ObjectBox files
      run: |
        dart run build_runner build --delete-conflicting-outputs
        
    - name: Download ONNX models and tokenizer
      run: |
        mkdir -p assets/models/tokenizers
        curl -L -o assets/models/nlp_visualize_opset3.onnx https://clip-as-service.s3.us-east-2.amazonaws.com/models/onnx/ViT-B-32/visual.onnx
        curl -L -o assets/models/nlp_visualize.onnx https://clip-as-service.s3.us-east-2.amazonaws.com/models/onnx/ViT-B-32/visual.onnx
        curl -L -o assets/models/nlp_textual_opset3.onnx https://clip-as-service.s3.us-east-2.amazonaws.com/models/onnx/ViT-B-32/textual.onnx
        curl -L -o assets/models/nlp_textual.onnx https://clip-as-service.s3.us-east-2.amazonaws.com/models/onnx/ViT-B-32/textual.onnx
        curl -L -o assets/models/tokenizers/nlp_textual_tokenizer.txt.gz https://github.com/openai/CLIP/raw/main/clip/bpe_simple_vocab_16e6.txt.gz
        
    - name: Build iOS app (debug, no codesign)
      run: |
        flutter build ios --debug --no-codesign --verbose
        
    - name: Create iOS app archive
      run: |
        cd ios/build/ios/iphoneos
        zip -r SnappApp-iOS-Debug.zip Runner.app
        
    - name: Upload iOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-for-testing
        path: ios/build/ios/iphoneos/SnappApp-iOS-Debug.zip
        retention-days: 7
        
    - name: Build summary
      run: |
        echo "ðŸŽ‰ iOS app built successfully!"
        echo "ðŸ“± Download the artifact from GitHub Actions"
        echo "ðŸ“¤ Upload SnappApp-iOS-Debug.zip to BrowserStack"
        echo "ðŸ§ª Ready for vector cleanup testing!"
